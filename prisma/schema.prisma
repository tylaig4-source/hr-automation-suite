// ===========================================
// HR AUTOMATION SUITE - Schema do Banco de Dados
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// AUTENTICAÇÃO (NextAuth.js)
// ===========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===========================================
// USUÁRIOS E EMPRESAS
// ===========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Para login com email/senha
  role          UserRole  @default(HR_ANALYST)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  accounts      Account[]
  sessions      Session[]
  executions    Execution[]
  templates     UserTemplate[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
}

enum UserRole {
  ADMIN // Administrador do sistema
  COMPANY_ADMIN // Admin da empresa
  HR_MANAGER // Gerente de RH
  HR_ANALYST // Analista de RH
  MANAGER // Gestor/Líder
  EMPLOYEE // Colaborador (acesso limitado)
}

model Company {
  id       String      @id @default(cuid())
  name     String
  slug     String      @unique
  logo     String?
  plan     CompanyPlan @default(TRIAL)
  settings Json? // Configurações customizadas

  users              User[]
  executions         Execution[]
  customPrompts      CompanyPrompt[]
  subscription       Subscription?
  payments           Payment[]
  enterpriseRequests EnterpriseRequest[]

  // Limites do plano
  maxUsers      Int @default(1)
  maxExecutions Int @default(10) // Por mês
  credits       Int @default(10) // Créditos para uso de agentes

  // Trial de 3 dias
  trialStartDate DateTime? // Data de início do trial
  trialEndDate   DateTime? // Data de término do trial
  isTrialing     Boolean   @default(true) // Se está em período de trial

  // Stripe Customer ID
  stripeCustomerId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([stripeCustomerId])
  @@index([isTrialing])
}

enum CompanyPlan {
  TRIAL // Grátis - 3 dias, 1 usuário, 10 execuções
  STARTER // Legado - convertido para TRIAL em novas contas
  PROFESSIONAL // R$ 497/mês - 5 usuários, 500 execuções
  ENTERPRISE // Custom - Ilimitado
}

// ===========================================
// PLANOS (Configuráveis no Admin)
// ===========================================

model Plan {
  id String @id @default(cuid())

  // Identificação
  planId      String  @unique // TRIAL, STARTER, PROFESSIONAL, ENTERPRISE
  name        String // Nome do plano
  description String? @db.Text

  // Preços
  monthlyPrice Float? // Preço mensal em R$
  yearlyPrice  Float? // Preço anual por mês em R$
  yearlyTotal  Float? // Preço total anual em R$

  // Limites
  maxUsers      Int? // Máximo de usuários (null = ilimitado)
  maxExecutions Int? // Máximo de execuções por mês (null = ilimitado)
  maxCredits    Int? // Máximo de créditos (null = ilimitado)

  // Features (JSON array de strings)
  features Json // Array de features do plano

  // Configurações
  isActive     Boolean @default(true)
  isPopular    Boolean @default(false) // Badge "Mais Popular"
  isTrial      Boolean @default(false) // Se é plano de trial
  isEnterprise Boolean @default(false) // Se é plano enterprise (customizado)

  // IDs do Stripe
  stripePriceIdMonthly String? // ID do preço mensal no Stripe
  stripePriceIdYearly  String? // ID do preço anual no Stripe

  // Ordem de exibição
  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@index([isActive])
  @@index([orderIndex])
}

// ===========================================
// ASSINATURAS E PAGAMENTOS (Stripe)
// ===========================================

model Subscription {
  id String @id @default(cuid())

  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // IDs do Stripe
  stripeSubscriptionId  String? @unique // ID da assinatura no Stripe
  stripePriceId         String? // ID do preço no Stripe
  stripePaymentMethodId String? // ID do método de pagamento salvo

  // Dados da assinatura
  planId      String // STARTER, PROFESSIONAL, ENTERPRISE
  billingType BillingType @default(MONTHLY)
  value       Float // Valor da assinatura

  // Status
  status SubscriptionStatus @default(PENDING)

  // Datas
  nextDueDate DateTime? // Próximo vencimento
  endDate     DateTime? // Data de término (se cancelada)

  // Configurações
  cycle       String  @default("MONTHLY") // MONTHLY, YEARLY
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([stripeSubscriptionId])
}

enum SubscriptionStatus {
  PENDING // Aguardando primeiro pagamento
  ACTIVE // Ativa
  OVERDUE // Com pagamento atrasado
  CANCELED // Cancelada
  EXPIRED // Expirada
}

enum BillingType {
  MONTHLY
  YEARLY
}

model Payment {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // IDs do Stripe
  stripePaymentIntentId String? @unique // ID do PaymentIntent no Stripe
  stripeChargeId        String? // ID da cobrança no Stripe

  // Dados do pagamento
  value       Float // Valor
  netValue    Float? // Valor líquido
  description String?

  // Forma de pagamento
  billingType PaymentMethod // PIX, BOLETO, CREDIT_CARD

  // Datas
  dueDate     DateTime // Vencimento
  paymentDate DateTime? // Data do pagamento (quando pago)

  // Status
  status PaymentStatus @default(PENDING)

  // Links e dados adicionais
  invoiceUrl    String? // URL da fatura
  bankSlipUrl   String? // URL do boleto
  pixQrCode     String? @db.Text // QR Code PIX
  pixCopiaECola String? @db.Text // Código PIX Copia e Cola

  // Dados do cartão (se aplicável)
  creditCardNumber String? // Últimos 4 dígitos
  creditCardBrand  String? // VISA, MASTERCARD, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
}

enum PaymentStatus {
  PENDING // Aguardando pagamento
  RECEIVED // Recebido (crédito confirmado)
  CONFIRMED // Confirmado
  OVERDUE // Vencido
  REFUNDED // Estornado
  RECEIVED_IN_CASH // Recebido em dinheiro
  REFUND_REQUESTED // Estorno solicitado
  REFUND_IN_PROGRESS // Estorno em processamento
  CHARGEBACK_REQUESTED // Chargeback solicitado
  CHARGEBACK_DISPUTE // Disputa de chargeback
  AWAITING_CHARGEBACK_REVERSAL // Aguardando reversão de chargeback
  DUNNING_REQUESTED // Negativação solicitada
  DUNNING_RECEIVED // Negativado
  AWAITING_RISK_ANALYSIS // Aguardando análise de risco
}

enum PaymentMethod {
  BOLETO
  PIX
  CREDIT_CARD
  DEBIT_CARD
  UNDEFINED
}

// ===========================================
// NOTIFICAÇÕES
// ===========================================

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  message String
  read    Boolean          @default(false)
  type    NotificationType @default(INFO)
  link    String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// ===========================================
// CATEGORIAS E AGENTES
// ===========================================

model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  icon        String? // Nome do ícone (lucide-react)
  color       String? // Cor do tema
  orderIndex  Int     @default(0)
  isActive    Boolean @default(true)

  agents Agent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([orderIndex])
}

model Agent {
  id         String   @id @default(cuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  name             String
  slug             String  @unique
  description      String?
  shortDescription String? // Para cards

  // Prompt e configurações
  promptTemplate String  @db.Text // Prompt com variáveis {{campo}}
  systemPrompt   String? @db.Text // System message para a IA
  inputSchema    Json // Definição dos campos do formulário
  outputTemplate String? @db.Text // Estrutura esperada do output

  // Métricas
  estimatedTimeSaved Int? // Minutos economizados
  averageRating      Float? @default(0)
  totalExecutions    Int    @default(0)

  // Configurações
  isActive  Boolean @default(true)
  isPremium Boolean @default(false) // Apenas planos superiores
  version   Int     @default(1)

  // Configurações de IA
  temperature Float  @default(0.7)
  maxTokens   Int    @default(4000)
  model       String @default("gemini-2.5-pro-preview")

  executions    Execution[]
  templates     UserTemplate[]
  customPrompts CompanyPrompt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
}

// ===========================================
// EXECUÇÕES
// ===========================================

model Execution {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id])

  // Dados da execução
  inputs     Json // Dados preenchidos pelo usuário
  promptSent String @db.Text // Prompt final enviado para IA
  output     String @db.Text // Resposta da IA

  // Métricas
  tokensUsed      Int?
  executionTimeMs Int?

  // Feedback
  rating   Int? // 1-5
  feedback String? // Comentário opcional

  // Status
  status       ExecutionStatus @default(COMPLETED)
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([companyId])
  @@index([agentId])
  @@index([createdAt])
}

enum ExecutionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ===========================================
// TEMPLATES DO USUÁRIO
// ===========================================

model UserTemplate {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id])

  name        String
  description String?
  inputs      Json // Inputs pré-preenchidos

  isDefault Boolean @default(false) // Template padrão para o agente

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([agentId])
}

// ===========================================
// PROMPTS CUSTOMIZADOS POR EMPRESA
// ===========================================

model CompanyPrompt {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id])

  customPrompt      String? @db.Text // Sobrescreve o prompt padrão
  additionalContext String? @db.Text // Contexto adicional da empresa

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, agentId])
  @@index([companyId])
  @@index([agentId])
}

// ===========================================
// LOGS E AUDITORIA (Opcional - para Enterprise)
// ===========================================

model AuditLog {
  id String @id @default(cuid())

  userId    String?
  companyId String?

  action     String // CREATE, UPDATE, DELETE, EXECUTE, etc.
  resource   String // Agent, Execution, User, etc.
  resourceId String?

  details   Json? // Detalhes adicionais
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([companyId])
  @@index([action])
  @@index([createdAt])
}

// ===========================================
// WEBHOOK LOGS (para debug)
// ===========================================

model WebhookLog {
  id String @id @default(cuid())

  event   String // Tipo do evento
  payload Json // Payload recebido
  status  String // SUCCESS, ERROR
  error   String? // Mensagem de erro se houver

  processedAt DateTime @default(now())

  @@index([event])
  @@index([processedAt])
}

// ===========================================
// SOLICITAÇÕES ENTERPRISE
// ===========================================

model EnterpriseRequest {
  id String @id @default(cuid())

  // Dados da empresa
  companyName String
  contactName String
  email       String
  phone       String?

  // Informações adicionais
  employees   Int? // Número de funcionários
  currentPlan String? // Plano atual (se aplicável)
  message     String? @db.Text

  // Status
  status RequestStatus @default(PENDING)
  notes  String?       @db.Text // Notas do admin

  // Relacionamentos
  companyId String? // Se já tiver empresa cadastrada
  company   Company? @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([createdAt])
}

enum RequestStatus {
  PENDING // Aguardando contato
  CONTACTED // Contatado
  IN_PROGRESS // Em negociação
  APPROVED // Aprovado
  REJECTED // Rejeitado
  CLOSED // Fechado
}

// ===========================================
// CONFIGURAÇÕES DO SISTEMA
// ===========================================

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique // Ex: "stripe_secret_key", "stripe_publishable_key", "stripe_webhook_secret"
  value     String   @db.Text // Valor criptografado
  encrypted Boolean  @default(true) // Se o valor está criptografado
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}
